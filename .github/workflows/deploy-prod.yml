name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip post-deployment tests'
        required: false
        type: boolean
        default: false
      approval_override:
        description: 'Override approval requirement (emergency only)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  deployments: write

env:
  TERRAFORM_VERSION: '1.7.0'
  AWS_REGION: us-east-1
  ENVIRONMENT: prod

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify staging deployment
        run: |
          echo "Verifying staging environment is healthy..."
          # Add checks to verify staging is working
          echo "Staging verification completed"

      - name: Check deployment window
        run: |
          # Check if deployment is within allowed time window
          HOUR=$(date +%H)
          DAY=$(date +%u)

          # Allow deployments Monday-Friday, 9 AM - 5 PM UTC (configurable)
          if [ "$DAY" -gt 5 ]; then
            echo "Warning: Deploying on weekend"
          fi

          if [ "$HOUR" -lt 9 ] || [ "$HOUR" -gt 17 ]; then
            echo "Warning: Deploying outside business hours"
          fi

          echo "Deployment window check completed"

      - name: Verify prerequisites
        run: |
          echo "Checking deployment prerequisites..."
          # Add checks for:
          # - Database migrations are ready
          # - Feature flags are configured
          # - Monitoring is operational
          # - Rollback plan is documented
          echo "Prerequisites verified"

  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-PlanProd

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform init

      - name: Terraform Plan
        id: plan
        env:
          DESTROY_FLAG: ${{ github.event.inputs.destroy }}
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          if [ "${DESTROY_FLAG}" == "true" ]; then
            terraform plan -destroy -out=tfplan.binary
          else
            terraform plan -out=tfplan.binary
          fi
          terraform show -no-color tfplan.binary > tfplan.txt

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-prod
          path: |
            infrastructure/environments/prod/tfplan.binary
            infrastructure/environments/prod/tfplan.txt
          retention-days: 90

      - name: Display plan summary
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          echo "### Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo '```terraform' >> $GITHUB_STEP_SUMMARY
          cat tfplan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  manual-approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: plan
    environment:
      name: prod-approval
    steps:
      - name: Approval checkpoint
        run: |
          echo "Manual approval granted for production deployment"
          echo "Deployment will proceed to production environment"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: manual-approval
    environment:
      name: prod
      url: https://hyperion-fleet.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-prod
          path: infrastructure/environments/prod/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-DeployProd

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform init

      - name: Create deployment snapshot
        run: |
          echo "Creating pre-deployment snapshot..."
          # Add snapshot/backup logic before deployment
          echo "Snapshot created"

      - name: Terraform Apply
        id: apply
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform apply -auto-approve tfplan.binary

      - name: Get Terraform outputs
        id: outputs
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform output -json > outputs.json
          cat outputs.json

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-prod
          path: infrastructure/environments/prod/outputs.json
          retention-days: 365

  post-deployment-validation:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download Terraform outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-prod

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ValidationProd

      - name: Wait for stabilization
        run: |
          echo "Waiting for services to stabilize..."
          sleep 60
          echo "Stabilization period completed"

      - name: Run health checks
        run: |
          echo "Running health checks for production environment..."

          if [ ! -f outputs.json ]; then
            echo "Outputs file not found"
            exit 1
          fi

          # Extract and test endpoints
          API_ENDPOINT=$(jq -r '.api_endpoint.value // empty' outputs.json)
          if [ -n "$API_ENDPOINT" ]; then
            echo "Testing API endpoint: $API_ENDPOINT"

            # Retry health check up to 5 times
            for i in {1..5}; do
              response=$(curl -f -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/health")
              if [ "$response" == "200" ]; then
                echo "Health check passed"
                break
              fi
              echo "Attempt $i failed with status: $response"
              sleep 10
            done

            if [ "$response" != "200" ]; then
              echo "Health check failed after retries"
              exit 1
            fi
          fi

      - name: Run smoke tests
        run: |
          echo "Running critical smoke tests..."
          # Add critical smoke test commands
          echo "Smoke tests passed"

      - name: Verify monitoring and alerts
        run: |
          echo "Verifying monitoring systems..."
          # Check that monitoring is receiving data
          # Verify alerts are configured
          echo "Monitoring verification completed"

      - name: Run synthetic transactions
        run: |
          echo "Running synthetic transaction tests..."
          # Test critical user flows
          echo "Synthetic tests passed"

  monitoring-warmup:
    name: Initialize Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Configure monitoring baselines
        run: |
          echo "Setting up monitoring baselines..."
          # Configure dashboards, alerts, and baselines
          echo "Monitoring configured"

      - name: Enable enhanced monitoring
        run: |
          echo "Enabling enhanced monitoring for deployment window..."
          # Temporarily increase monitoring sensitivity
          echo "Enhanced monitoring enabled"

  update-deployment-status:
    name: Update Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, post-deployment-validation, monitoring-warmup]
    if: always()
    steps:
      - name: Set deployment status
        uses: actions/github-script@v7
        env:
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          VALIDATION_RESULT: ${{ needs.post-deployment-validation.result }}
          MONITORING_RESULT: ${{ needs.monitoring-warmup.result }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
        with:
          script: |
            const deployResult = process.env.DEPLOY_RESULT;
            const validationResult = process.env.VALIDATION_RESULT;
            const monitoringResult = process.env.MONITORING_RESULT;
            const sha = process.env.COMMIT_SHA;
            const actor = process.env.ACTOR;

            const success = deployResult === 'success' &&
                           (validationResult === 'success' || validationResult === 'skipped') &&
                           monitoringResult === 'success';
            const status = success ? '✅ Successful' : '❌ Failed';

            const output = `## Production Deployment Status

            **Status:** ${status}
            **Commit:** ${sha.substring(0, 7)}
            **Environment:** production
            **Deployed by:** ${actor}
            **Timestamp:** ${new Date().toISOString()}

            ### Deployment Results
            - Terraform Deploy: ${deployResult === 'success' ? '✅' : '❌'} ${deployResult}
            - Post-Deployment Validation: ${validationResult === 'success' ? '✅' : validationResult === 'skipped' ? '⏭️' : '❌'} ${validationResult}
            - Monitoring Setup: ${monitoringResult === 'success' ? '✅' : '❌'} ${monitoringResult}

            ### Post-Deployment Actions
            ${success ? 'Production deployment completed successfully. Monitor dashboards for the next 24 hours.' : 'Production deployment encountered issues. Initiate incident response if needed.'}
            `;

            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha,
              environment: 'prod',
              auto_merge: false,
              required_contexts: []
            }).catch(() => null);

            if (deployment) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: success ? 'success' : 'failure',
                description: `Production deployment ${success ? 'succeeded' : 'failed'}`,
                environment: 'prod',
                environment_url: 'https://hyperion-fleet.example.com'
              });
            }

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: output
            });

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [update-deployment-status]
    if: always()
    steps:
      - name: Send notification
        env:
          DEPLOY_STATUS: ${{ needs.deploy.result }}
        run: |
          if [ "${DEPLOY_STATUS}" == "success" ]; then
            echo "Production deployment successful - send success notification"
          else
            echo "Production deployment failed - send critical alert"
          fi
