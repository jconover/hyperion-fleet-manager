name: Deploy to Dev

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - 'scripts/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TERRAFORM_VERSION: '1.7.0'
  AWS_REGION: us-east-1
  ENVIRONMENT: dev

jobs:
  deploy:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: https://dev.hyperion-fleet.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_DEV }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-DeployDev

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform init

      - name: Terraform Plan
        id: plan
        env:
          DESTROY_FLAG: ${{ github.event.inputs.destroy }}
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          if [ "${DESTROY_FLAG}" == "true" ]; then
            terraform plan -destroy -out=tfplan.binary
          else
            terraform plan -out=tfplan.binary
          fi
          terraform show -no-color tfplan.binary > tfplan.txt

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-dev
          path: infrastructure/environments/dev/tfplan.txt
          retention-days: 30

      - name: Terraform Apply
        id: apply
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform apply -auto-approve tfplan.binary

      - name: Get Terraform outputs
        id: outputs
        run: |
          cd infrastructure/environments/${ENVIRONMENT}
          terraform output -json > outputs.json
          cat outputs.json

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-dev
          path: infrastructure/environments/dev/outputs.json
          retention-days: 90

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Terraform outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-dev

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_DEV }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-SmokeTests

      - name: Run health checks
        run: |
          echo "Running smoke tests for dev environment..."

          # Check if outputs file exists
          if [ ! -f outputs.json ]; then
            echo "Outputs file not found"
            exit 1
          fi

          # Extract endpoints from Terraform outputs
          API_ENDPOINT=$(jq -r '.api_endpoint.value // empty' outputs.json)
          if [ -n "$API_ENDPOINT" ]; then
            echo "Testing API endpoint: $API_ENDPOINT"
            curl -f -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/health" || echo "API health check failed"
          fi

          # Check AWS resources
          echo "Verifying AWS resources..."
          aws sts get-caller-identity

          # Add more smoke tests as needed
          echo "Smoke tests completed"

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          # Add integration test commands here
          echo "Integration tests completed"

  update-deployment-status:
    name: Update Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    steps:
      - name: Set deployment status
        uses: actions/github-script@v8
        env:
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          SMOKE_RESULT: ${{ needs.smoke-tests.result }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          script: |
            const deployResult = process.env.DEPLOY_RESULT;
            const smokeResult = process.env.SMOKE_RESULT;
            const sha = process.env.COMMIT_SHA;

            const success = deployResult === 'success' && smokeResult === 'success';
            const status = success ? '✅ Successful' : '❌ Failed';

            const output = `## Deployment Status: Dev Environment

            **Status:** ${status}
            **Commit:** ${sha.substring(0, 7)}
            **Environment:** dev
            **Timestamp:** ${new Date().toISOString()}

            ### Results
            - Terraform Deploy: ${deployResult === 'success' ? '✅' : '❌'} ${deployResult}
            - Smoke Tests: ${smokeResult === 'success' ? '✅' : '❌'} ${smokeResult}

            ${success ? '✅ Deployment successful and smoke tests passed!' : '⚠️ Deployment failed or smoke tests did not pass. Check the workflow logs for details.'}
            `;

            // Create deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: success ? 'success' : 'failure',
              description: `Dev deployment ${success ? 'succeeded' : 'failed'}`,
              environment: 'dev'
            }).catch(() => {
              console.log('Could not create deployment status');
            });

            // Comment on commit
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: output
            });

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "Deployment to dev failed. Notification would be sent here."
          # Add notification logic (Slack, email, etc.)
          # Example: curl -X POST $SLACK_WEBHOOK_URL -d '{"text":"Dev deployment failed"}'
