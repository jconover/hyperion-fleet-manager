---
# tasks/ntp.yml - Configure NTP time synchronization

- name: Configure NTP servers
  ansible.windows.win_powershell:
    script: |
      $ntpServers = "{{ windows_ntp_servers | join(' ') }}"

      # Configure as NTP client
      w32tm /config /manualpeerlist:"$ntpServers" /syncfromflags:manual /reliable:no /update

      Write-Output "NTP servers configured: $ntpServers"
  register: ntp_config_result

- name: Set Windows Time service type
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Parameters
    name: Type
    data: NTP
    type: string

- name: Configure NTP client settings
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: "{{ item.type }}"
  loop:
    - name: Enabled
      data: 1
      type: dword
    - name: SpecialPollInterval
      data: 3600  # Poll every hour
      type: dword

- name: Restart Windows Time service
  ansible.windows.win_service:
    name: W32Time
    state: restarted
  notify: Sync time

- name: Force time synchronization
  ansible.windows.win_powershell:
    script: |
      w32tm /resync /force
      $status = w32tm /query /status
      Write-Output $status
  register: time_sync_result

- name: Display NTP configuration
  ansible.builtin.debug:
    msg: |
      NTP Configuration:
      - Servers: {{ windows_ntp_servers | join(', ') }}
      - Status: Synchronized
    verbosity: 1
