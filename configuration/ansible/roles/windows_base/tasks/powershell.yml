---
# tasks/powershell.yml - Configure PowerShell settings

- name: Set PowerShell execution policy
  ansible.windows.win_powershell:
    script: |
      Set-ExecutionPolicy -ExecutionPolicy {{ powershell_execution_policy }} -Scope LocalMachine -Force
      $policy = Get-ExecutionPolicy -Scope LocalMachine
      Write-Output "Execution policy set to: $policy"
  register: execution_policy_result
  changed_when: "'set to' in execution_policy_result.output[0]"

- name: Enable PowerShell remoting
  ansible.windows.win_powershell:
    script: |
      $remoting = Get-PSSessionConfiguration -Name Microsoft.PowerShell -ErrorAction SilentlyContinue
      if (-not $remoting) {
        Enable-PSRemoting -Force -SkipNetworkProfileCheck
        Write-Output "PowerShell remoting enabled"
      } else {
        Write-Output "PowerShell remoting already enabled"
      }
  register: ps_remoting_result
  when: powershell_enable_remoting | bool

- name: Configure PowerShell module logging
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging
    name: EnableModuleLogging
    data: 1
    type: dword

- name: Configure PowerShell script block logging
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
    name: EnableScriptBlockLogging
    data: 1
    type: dword

- name: Ensure NuGet provider is installed
  ansible.windows.win_powershell:
    script: |
      $nuget = Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue
      if (-not $nuget -or $nuget.Version -lt [Version]'{{ _nuget_provider_minimum_version }}') {
        Install-PackageProvider -Name NuGet -MinimumVersion {{ _nuget_provider_minimum_version }} -Force
        Write-Output "NuGet provider installed"
      } else {
        Write-Output "NuGet provider already installed: $($nuget.Version)"
      }
  register: nuget_result

- name: Configure PSGallery as trusted repository
  ansible.windows.win_powershell:
    script: |
      $repo = Get-PSRepository -Name PSGallery -ErrorAction SilentlyContinue
      if ($repo.InstallationPolicy -ne 'Trusted') {
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Write-Output "PSGallery set as trusted"
      } else {
        Write-Output "PSGallery already trusted"
      }
  register: psgallery_result
