---
# baseline.yml - Apply Baseline Configuration to Windows Fleet
#
# This playbook applies the foundational configuration to all Windows hosts:
# - Windows base configuration (hostname, time, services, registry)
# - Chocolatey package manager with common packages
# - Security hardening (firewall, audit policies, user restrictions)
#
# Usage:
#   ansible-playbook -i inventories/production playbooks/baseline.yml
#   ansible-playbook -i inventories/production playbooks/baseline.yml --tags security
#   ansible-playbook -i inventories/production playbooks/baseline.yml --check --diff

- name: "Apply Baseline Configuration to Windows Fleet"
  hosts: all
  gather_facts: true
  become: true
  become_method: runas
  become_user: Administrator

  vars:
    # Baseline configuration defaults
    baseline_apply_windows_base: true
    baseline_apply_chocolatey: true
    baseline_apply_security_hardening: true

    # Common Chocolatey packages for all hosts
    baseline_common_packages:
      - name: 7zip
        state: present
      - name: notepadplusplus
        state: present
      - name: git
        state: present
      - name: awscli
        state: present
      - name: powershell-core
        state: present
      - name: sysinternals
        state: present
      - name: googlechrome
        state: present
        install_args: "--ignore-checksums"
      - name: vscode
        state: present

    # Windows services to configure
    baseline_windows_services:
      - name: wuauserv
        state: started
        start_mode: auto
      - name: WinRM
        state: started
        start_mode: auto
      - name: BITS
        state: started
        start_mode: auto
      - name: EventLog
        state: started
        start_mode: auto
      - name: LanmanWorkstation
        state: started
        start_mode: auto

    # Registry settings for baseline
    baseline_registry_settings:
      - path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: NoAutoUpdate
        data: 0
        type: dword
      - path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: EnableLUA
        data: 1
        type: dword
      - path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword

  tags:
    - baseline
    - common

  pre_tasks:
    - name: Validate Windows target
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Windows"
        fail_msg: "This playbook only supports Windows hosts. Detected OS: {{ ansible_os_family }}"
        success_msg: "Windows host validated: {{ inventory_hostname }}"
      tags: always

    - name: Display baseline configuration parameters
      ansible.builtin.debug:
        msg: |
          Baseline Configuration Parameters:
          - Apply Windows Base: {{ baseline_apply_windows_base }}
          - Apply Chocolatey: {{ baseline_apply_chocolatey }}
          - Apply Security Hardening: {{ baseline_apply_security_hardening }}
          - Common Packages: {{ baseline_common_packages | length }}
          - Environment: {{ hyperion_environment | default('not set') }}
      tags: always

    - name: Create Hyperion configuration directory
      ansible.windows.win_file:
        path: C:\Hyperion\Config
        state: directory
      tags: always

    - name: Record baseline start time
      ansible.windows.win_copy:
        content: |
          {
            "baseline_start": "{{ ansible_date_time.iso8601 }}",
            "ansible_host": "{{ inventory_hostname }}",
            "environment": "{{ hyperion_environment | default('unknown') }}"
          }
        dest: C:\Hyperion\Config\baseline_status.json
      tags: always

  tasks:
    # =========================================================================
    # Windows Base Configuration
    # =========================================================================
    - name: Apply Windows base configuration
      when: baseline_apply_windows_base
      tags:
        - windows_base
        - base
      block:
        - name: Set Windows hostname if specified
          ansible.windows.win_hostname:
            name: "{{ hyperion_hostname }}"
          when: hyperion_hostname is defined
          register: hostname_result
          notify: Reboot required

        - name: Configure Windows timezone
          community.windows.win_timezone:
            timezone: "{{ hyperion_timezone | default('UTC') }}"
          tags: timezone

        - name: Configure NTP servers
          ansible.windows.win_shell: |
            w32tm /config /manualpeerlist:"{{ hyperion_ntp_servers | default('time.aws.com') }}" /syncfromflags:manual /reliable:yes /update
            Restart-Service w32time
            w32tm /resync /force
          changed_when: true
          tags: ntp

        - name: Configure Windows services
          ansible.windows.win_service:
            name: "{{ item.name }}"
            state: "{{ item.state }}"
            start_mode: "{{ item.start_mode }}"
          loop: "{{ baseline_windows_services }}"
          loop_control:
            label: "{{ item.name }}"
          tags: services

        - name: Apply registry settings
          ansible.windows.win_regedit:
            path: "{{ item.path }}"
            name: "{{ item.name }}"
            data: "{{ item.data }}"
            type: "{{ item.type }}"
          loop: "{{ baseline_registry_settings }}"
          loop_control:
            label: "{{ item.path }}\\{{ item.name }}"
          tags: registry

        - name: Configure Windows page file
          community.windows.win_pagefile:
            automatic: true
          tags: pagefile

        - name: Enable Remote Desktop
          ansible.windows.win_shell: |
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          changed_when: true
          tags: rdp

        - name: Configure Windows error reporting
          ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Microsoft\Windows\Windows Error Reporting
            name: Disabled
            data: 1
            type: dword
          tags: error_reporting

    # =========================================================================
    # Chocolatey Package Manager Configuration
    # =========================================================================
    - name: Configure Chocolatey and install common packages
      when: baseline_apply_chocolatey
      tags:
        - chocolatey
        - packages
      block:
        - name: Install Chocolatey package manager
          ansible.windows.win_shell: |
            if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
            }
            choco --version
          register: choco_install
          changed_when: "'Installing' in choco_install.stdout"
          tags: install_choco

        - name: Configure Chocolatey settings
          ansible.windows.win_shell: |
            choco feature enable -n=allowGlobalConfirmation
            choco feature enable -n=useRememberedArgumentsForUpgrades
            choco feature disable -n=showDownloadProgress
          changed_when: false
          tags: configure_choco

        - name: Install common Chocolatey packages
          chocolatey.chocolatey.win_chocolatey:
            name: "{{ item.name }}"
            state: "{{ item.state | default('present') }}"
            install_args: "{{ item.install_args | default(omit) }}"
            package_params: "{{ item.package_params | default(omit) }}"
            version: "{{ item.version | default(omit) }}"
            allow_prerelease: "{{ item.allow_prerelease | default(false) }}"
          loop: "{{ baseline_common_packages }}"
          loop_control:
            label: "{{ item.name }}"
          register: choco_packages
          retries: 3
          delay: 10
          until: choco_packages is succeeded
          tags: install_packages

        - name: Update PATH environment variable
          ansible.windows.win_path:
            elements:
              - C:\Program Files\Git\cmd
              - C:\Program Files\Amazon\AWSCLIV2
              - C:\Program Files\PowerShell\7
            state: present
          tags: path

    # =========================================================================
    # Security Hardening
    # =========================================================================
    - name: Apply security hardening configuration
      when: baseline_apply_security_hardening
      tags:
        - security_hardening
        - security
        - hardening
      block:
        - name: Configure Windows Firewall - Enable profiles
          community.windows.win_firewall:
            state: enabled
            profiles:
              - Domain
              - Private
              - Public
          tags: firewall

        - name: Configure essential firewall rules - WinRM
          community.windows.win_firewall_rule:
            name: "Hyperion WinRM HTTPS"
            localport: 5986
            action: allow
            direction: in
            protocol: tcp
            state: present
            enabled: true
          tags: firewall

        - name: Configure essential firewall rules - RDP
          community.windows.win_firewall_rule:
            name: "Hyperion RDP"
            localport: 3389
            action: allow
            direction: in
            protocol: tcp
            state: present
            enabled: true
            profiles:
              - Domain
              - Private
          tags: firewall

        - name: Configure audit policies
          ansible.windows.win_shell: |
            # Enable comprehensive auditing
            auditpol /set /category:"Account Logon" /success:enable /failure:enable
            auditpol /set /category:"Account Management" /success:enable /failure:enable
            auditpol /set /category:"Logon/Logoff" /success:enable /failure:enable
            auditpol /set /category:"Object Access" /success:enable /failure:enable
            auditpol /set /category:"Policy Change" /success:enable /failure:enable
            auditpol /set /category:"Privilege Use" /success:enable /failure:enable
            auditpol /set /category:"System" /success:enable /failure:enable
          changed_when: true
          tags: audit

        - name: Configure password policy
          ansible.windows.win_shell: |
            # Set password policy via secedit
            $secEditConfig = @"
            [Unicode]
            Unicode=yes
            [System Access]
            MinimumPasswordLength = 14
            PasswordComplexity = 1
            MaximumPasswordAge = 90
            MinimumPasswordAge = 1
            PasswordHistorySize = 24
            LockoutBadCount = 5
            ResetLockoutCount = 30
            LockoutDuration = 30
            "@
            $tempFile = "$env:TEMP\secpol.inf"
            $secEditConfig | Out-File -FilePath $tempFile -Encoding unicode
            secedit /configure /db secedit.sdb /cfg $tempFile /quiet
            Remove-Item $tempFile -Force
          changed_when: true
          tags: password_policy

        - name: Disable unnecessary Windows features
          ansible.windows.win_optional_feature:
            name: "{{ item }}"
            state: absent
          loop:
            - SMB1Protocol
            - TelnetClient
            - TFTP
          ignore_errors: true
          tags: features

        - name: Configure Windows Defender settings
          ansible.windows.win_shell: |
            Set-MpPreference -DisableRealtimeMonitoring $false
            Set-MpPreference -DisableBehaviorMonitoring $false
            Set-MpPreference -DisableIOAVProtection $false
            Set-MpPreference -DisablePrivacyMode $false
            Set-MpPreference -SignatureScheduleDay Everyday
            Set-MpPreference -SignatureUpdateInterval 4
            Update-MpSignature
          changed_when: true
          ignore_errors: true
          tags: defender

        - name: Configure Local Security Policy - User Rights
          ansible.windows.win_user_right:
            name: "{{ item.name }}"
            users: "{{ item.users }}"
            action: set
          loop:
            - name: SeRemoteInteractiveLogonRight
              users:
                - Administrators
                - Remote Desktop Users
            - name: SeNetworkLogonRight
              users:
                - Administrators
                - Authenticated Users
            - name: SeDenyNetworkLogonRight
              users:
                - Guest
          loop_control:
            label: "{{ item.name }}"
          tags: user_rights

        - name: Configure TLS settings
          ansible.windows.win_regedit:
            path: "{{ item.path }}"
            name: "{{ item.name }}"
            data: "{{ item.data }}"
            type: "{{ item.type }}"
          loop:
            # Disable TLS 1.0
            - path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server
              name: Enabled
              data: 0
              type: dword
            - path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Client
              name: Enabled
              data: 0
              type: dword
            # Disable TLS 1.1
            - path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server
              name: Enabled
              data: 0
              type: dword
            - path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Client
              name: Enabled
              data: 0
              type: dword
            # Enable TLS 1.2
            - path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server
              name: Enabled
              data: 1
              type: dword
            - path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client
              name: Enabled
              data: 1
              type: dword
          loop_control:
            label: "{{ item.path }}"
          tags: tls

  post_tasks:
    - name: Record baseline completion
      ansible.windows.win_copy:
        content: |
          {
            "baseline_complete": "{{ lookup('pipe', 'date -Iseconds') }}",
            "ansible_host": "{{ inventory_hostname }}",
            "environment": "{{ hyperion_environment | default('unknown') }}",
            "windows_base": {{ baseline_apply_windows_base | lower }},
            "chocolatey": {{ baseline_apply_chocolatey | lower }},
            "security_hardening": {{ baseline_apply_security_hardening | lower }},
            "packages_installed": {{ baseline_common_packages | length }}
          }
        dest: C:\Hyperion\Config\baseline_complete.json
      tags: always

    - name: Display baseline completion summary
      ansible.builtin.debug:
        msg: |
          Baseline configuration complete for {{ inventory_hostname }}
          - Windows Base: {{ baseline_apply_windows_base }}
          - Chocolatey: {{ baseline_apply_chocolatey }}
          - Security Hardening: {{ baseline_apply_security_hardening }}
      tags: always

  handlers:
    - name: Reboot required
      ansible.windows.win_reboot:
        reboot_timeout: 600
        post_reboot_delay: 60
        msg: "Ansible baseline configuration requires reboot"
      when: hyperion_allow_reboot | default(false)
